{% extends "base.html" %}
{% block title %}Quiz{% endblock %}
{% block content %}

<style>
  .quiz-wrap { max-width: 900px; margin: 0 auto; }
  .chip { font-size:.8rem; padding:.25rem .5rem; border-radius:999px; }
  .chip.study { background:#e8f5e9; color:#1b5e20; }
  .chip.exam  { background:#fff8e1; color:#795300; }
  .q-card { border:0; border-radius: 1rem; box-shadow: 0 16px 40px rgba(0,0,0,.06); }
  .choice-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap: .75rem; }
  .choice { position:relative; }
  .choice input { position:absolute; opacity:0; inset:0; cursor:pointer; }
  .choice label {
    display:flex; gap:.75rem; align-items:flex-start;
    border:1px solid #e7e7ea; border-radius:.75rem; padding:.9rem 1rem;
    background:#fff; cursor:pointer; transition: all .15s ease;
    min-height: 64px;
  }
  .choice:hover label { border-color:#bfc4d1; box-shadow:0 8px 24px rgba(0,0,0,.04); }
  .dot {
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:50%; border:1px solid #c9ceda; font-weight:600; font-size:.9rem;
    background:#f8f9fc;
  }
  .choice input:checked + label {
    border-color:#0d6efd; box-shadow:0 0 0 3px rgba(13,110,253,.15);
  }
  .choice input:checked + label .dot {
    background:#0d6efd; color:#fff; border-color:#0d6efd;
  }
  .progress { height:.6rem; background:#eef1f6; }
  .progress-bar { background:#0d6efd; }
  .footer-actions { display:flex; gap:.5rem; justify-content:center; }
</style>

<div class="quiz-wrap">
  <div class="card q-card p-4 p-md-5">
    <!-- Top row -->
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="d-flex align-items-center gap-2">
        {% if session.get('mode') == 'study' %}
          <span class="chip study">üéØ Study Mode</span>
        {% else %}
          <span class="chip exam">üìù Exam Mode</span>
        {% endif %}
        <span class="text-muted">Question {{ number }} of {{ total }}</span>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index') }}">Home</a>
        <a class="btn btn-sm btn-outline-danger" href="{{ url_for('summary') }}">End session</a>
      </div>
    </div>

    {% set pct = (number/total*100)|round(0,'floor') %}
    <div class="progress mb-4">
      <div class="progress-bar" role="progressbar" style="width: {{ pct }}%;" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    {% if repeat %}
      <div class="alert alert-warning d-flex align-items-center gap-2" role="alert">
        <span>‚ö†Ô∏è</span> <div>Note: You missed this question earlier.</div>
      </div>
    {% endif %}

    <!-- Question -->
    <h2 class="h4 mb-3">{{ q.question }}</h2>

    <!-- Options -->
    <form id="quiz-form" method="POST">
      <div class="choice-grid">
        {% for letter, text in options %}
          <div class="choice">
            <input id="opt-{{ letter }}" type="radio" name="answer" value="{{ letter }}" required>
            <label for="opt-{{ letter }}">
              <span class="dot">{{ letter }}</span>
              <span>{{ text }}</span>
            </label>
          </div>
        {% endfor %}
      </div>

      <div class="mt-4 footer-actions">
        <button id="submitBtn" class="btn btn-primary btn-lg px-5" type="submit" disabled>Submit</button>
      </div>
    </form>

    <!-- Feedback -->
    {% if feedback %}
      {% set status, info = feedback %}
      <div class="text-center mt-3">
        {% if status == 'correct' %}
          <span class="badge bg-success px-3 py-2">‚úÖ Correct</span>
        {% else %}
          <span class="badge bg-danger px-3 py-2">‚ùå Wrong</span>
          <small class="text-muted ms-2">Correct answer: <strong>{{ info }}</strong></small>
        {% endif %}
      </div>
    {% endif %}

    <div class="text-center text-muted small mt-4">
      Tip: use keys <kbd>1</kbd>‚Äì<kbd>4</kbd> to select an option, then <kbd>Enter</kbd> to submit.
    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('quiz-form');
    const submitBtn = document.getElementById('submitBtn');
    const radios = Array.from(document.querySelectorAll('input[name="answer"]'));
    const letters = ['A','B','C','D'];

    function updateButton() {
      submitBtn.disabled = !radios.some(r => r.checked);
    }
    radios.forEach(r => r.addEventListener('change', updateButton));
    updateButton();

    document.addEventListener('keydown', function (e) {
      const map = {'1':0,'2':1,'3':2,'4':3};
      if (map.hasOwnProperty(e.key)) {
        const r = document.querySelector('input[name="answer"][value="'+letters[map[e.key]]+'"]');
        if (r) { r.click(); }
      }
      if (e.key === 'Enter' && !submitBtn.disabled) {
        form.submit();
      }
    });
  })();
</script>

{% endblock %}
