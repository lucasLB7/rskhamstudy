{% extends "base.html" %}
{% block title %}Quiz{% endblock %}
{% block content %}

<style>
  .quiz-wrap { max-width: 900px; margin: 0 auto; }
  .chip { font-size:.8rem; padding:.25rem .5rem; border-radius:999px; }
  .chip.study { background:#e8f5e9; color:#1b5e20; }
  .chip.exam  { background:#fff8e1; color:#795300; }
  .q-card { border:0; border-radius: 1rem; box-shadow: 0 16px 40px rgba(0,0,0,.06); }
  .choice-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap: .75rem; }
  .choice { position:relative; }
  .choice input { position:absolute; opacity:0; inset:0; cursor:pointer; }
  .choice label {
    display:flex; gap:.75rem; align-items:flex-start;
    border:1px solid #e7e7ea; border-radius:.75rem; padding:.9rem 1rem;
    background:#fff; cursor:pointer; transition: all .15s ease;
    min-height: 64px;
  }
  .choice:hover label { border-color:#bfc4d1; box-shadow:0 8px 24px rgba(0,0,0,.04); }
  .choice input:checked + label {
    border-color:#0d6efd; box-shadow:0 0 0 3px rgba(13,110,253,.15);
  }
  .progress { height:.6rem; background:#eef1f6; }
  .progress-bar { background:#0d6efd; }
  .footer-actions { display:flex; gap:.5rem; justify-content:center; }

  /* Image styling for stem and options */
  .q-stem img,
  .choice label img {
    display:block;
    max-height: 220px;
    width: 100%;
    object-fit: contain;
    border-radius:.5rem;
    border:1px solid #e7e7ea;
    background:#fff;
  }
</style>

<div class="quiz-wrap">
  <div class="card q-card p-4 p-md-5">
    <!-- Top row -->
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="d-flex align-items-center gap-2">
        {% if session.get('mode') == 'study' %}
          <span class="chip study">üéØ Study Mode</span>
        {% else %}
          <span class="chip exam">üìù Exam Mode</span>
        {% endif %}
        <span class="text-muted">Question {{ number }} of {{ total }}</span>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index') }}">Home</a>
        <a class="btn btn-sm btn-outline-danger" href="{{ url_for('summary') }}">End session</a>
      </div>
    </div>

    {% set pct = (number/total*100)|round(0,'floor') if total else 0 %}
    <div class="progress mb-4">
      <div class="progress-bar" role="progressbar" style="width: {{ pct }}%;" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    {% if repeat %}
      <div class="alert alert-warning d-flex align-items-center gap-2" role="alert">
        <span>‚ö†Ô∏è</span> <div>Note: You missed this question earlier.</div>
      </div>
    {% endif %}

    {# ---------- Question (supports text and/or image) ---------- #}
    {% set stem_img = q_stem_img or (q.question_image_url if q is defined else None) %}
    {% set stem_text = q_stem_text or (q.text if q is defined else None) or (q.question if q is defined else None) %}

    <div class="q-stem mb-3">
      {% if stem_img %}
        <img src="{{ stem_img }}" alt="Question image" loading="lazy" class="mb-3">
      {% endif %}
      {% if stem_text %}
        <h2 class="h5 mb-0">{{ stem_text }}</h2>
      {% endif %}
    </div>

    <!-- Options (no badges/letters/numbers) -->
    <form id="quiz-form" method="POST" novalidate>
      <div class="choice-grid">
        {% for item in options %}
          {% set letter = item[0] %}
          {% set text = item[1] if item|length > 1 else '' %}
          {% set img  = item[2] if item|length > 2 else None %}
          <div class="choice">
            <!-- still submit the hidden letter so backend logic is unchanged -->
            <input id="opt-{{ loop.index }}" type="radio" name="answer" value="{{ letter }}" required>
            <label for="opt-{{ loop.index }}">
              <span class="d-flex flex-column gap-2 w-100">
                {% if img %}
                  <img src="{{ img }}" alt="Option image" loading="lazy">
                {% endif %}
                {% if text %}
                  <span>{{ text }}</span>
                {% endif %}
              </span>
            </label>
          </div>
        {% endfor %}
      </div>

      <div class="mt-4 footer-actions">
        <button id="submitBtn" class="btn btn-primary btn-lg px-5" type="submit" disabled>Submit</button>
      </div>
    </form>

    <!-- Feedback -->
    {% if feedback %}
      {% set status, info = feedback %}
      <div class="text-center mt-3">
        {% if status == 'correct' %}
          <span class="badge bg-success px-3 py-2">‚úÖ Correct</span>
        {% else %}
          <span class="badge bg-danger px-3 py-2">‚ùå Wrong</span>
          <small class="text-muted ms-2">Correct answer: <strong>{{ info }}</strong></small>
        {% endif %}
      </div>
    {% endif %}

    <div class="text-center text-muted small mt-4">
      Tip: select an option, then press <kbd>Enter</kbd> to submit.
    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('quiz-form');
    const submitBtn = document.getElementById('submitBtn');
    const radios = Array.from(document.querySelectorAll('input[name="answer"]'));

    function updateButton() {
      submitBtn.disabled = !radios.some(r => r.checked);
    }
    radios.forEach(r => r.addEventListener('change', updateButton));
    updateButton();

    // Enter submits when something is selected
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !submitBtn.disabled) {
        form.submit();
      }
    });
  })();
</script>

{% endblock %}
