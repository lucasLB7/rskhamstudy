<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ 'Edit' if row else 'New' }} Question</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">{{ 'Edit' if row else 'New' }} Question</h3>

  <form method="post" enctype="multipart/form-data" class="card p-3 p-md-4 shadow-sm">
    <!-- Stem -->
    <div class="mb-3">
      <label class="form-label">Question text</label>
      <textarea name="text" class="form-control" rows="3">{{ row.text if row else '' }}</textarea>
      <div class="form-text">Leave blank if you upload a question image.</div>
    </div>

    <div class="mb-4">
      <label class="form-label">Question image</label>

      {% if row and row.question_image_url %}
        <div class="d-flex align-items-start gap-3 mb-2">
          <img src="{{ row.question_image_url }}" class="img-thumbnail" style="max-height:180px" alt="Current question image">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="remove_question_image" id="remove_question_image">
            <label class="form-check-label" for="remove_question_image">Remove image</label>
          </div>
        </div>
      {% endif %}

      <input type="file" name="question_image" id="question_image" accept="image/*" class="form-control">
      <div class="form-text">PNG, JPG, WEBP, GIF, SVG. Max ~5MB.</div>

      <!-- Live preview -->
      <div id="question_image_preview_wrap" class="mt-2 d-none">
        <img id="question_image_preview" class="img-thumbnail" style="max-height:180px" alt="New question image preview">
      </div>
    </div>

    <!-- Choices -->
    <div class="row g-4">
      <!-- Choice A -->
      <div class="col-md-6">
        <div class="mb-2">
          <label class="form-label">Choice A (text)</label>
          <input name="choice_a" class="form-control" value="{{ row.choice_a if row else '' }}">
          <div class="form-text">You may leave text empty if you upload an image.</div>
        </div>

        <label class="form-label">Choice A image</label>
        {% if row and row.choice_a_image_url %}
          <div class="d-flex align-items-start gap-3 mb-2">
            <img src="{{ row.choice_a_image_url }}" class="img-thumbnail" style="max-height:140px" alt="Current A image">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="remove_choice_a_image" id="remove_choice_a_image">
              <label class="form-check-label" for="remove_choice_a_image">Remove image</label>
            </div>
          </div>
        {% endif %}
        <input type="file" name="choice_a_image" id="choice_a_image" accept="image/*" class="form-control">
        <div id="choice_a_image_preview_wrap" class="mt-2 d-none">
          <img id="choice_a_image_preview" class="img-thumbnail" style="max-height:140px" alt="New A image preview">
        </div>
      </div>

      <!-- Choice B -->
      <div class="col-md-6">
        <div class="mb-2">
          <label class="form-label">Choice B (text)</label>
          <input name="choice_b" class="form-control" value="{{ row.choice_b if row else '' }}">
          <div class="form-text">You may leave text empty if you upload an image.</div>
        </div>

        <label class="form-label">Choice B image</label>
        {% if row and row.choice_b_image_url %}
          <div class="d-flex align-items-start gap-3 mb-2">
            <img src="{{ row.choice_b_image_url }}" class="img-thumbnail" style="max-height:140px" alt="Current B image">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="remove_choice_b_image" id="remove_choice_b_image">
              <label class="form-check-label" for="remove_choice_b_image">Remove image</label>
            </div>
          </div>
        {% endif %}
        <input type="file" name="choice_b_image" id="choice_b_image" accept="image/*" class="form-control">
        <div id="choice_b_image_preview_wrap" class="mt-2 d-none">
          <img id="choice_b_image_preview" class="img-thumbnail" style="max-height:140px" alt="New B image preview">
        </div>
      </div>

      <!-- Choice C -->
      <div class="col-md-6">
        <div class="mb-2">
          <label class="form-label">Choice C (text)</label>
          <input name="choice_c" class="form-control" value="{{ row.choice_c if row else '' }}">
          <div class="form-text">You may leave text empty if you upload an image.</div>
        </div>

        <label class="form-label">Choice C image</label>
        {% if row and row.choice_c_image_url %}
          <div class="d-flex align-items-start gap-3 mb-2">
            <img src="{{ row.choice_c_image_url }}" class="img-thumbnail" style="max-height:140px" alt="Current C image">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="remove_choice_c_image" id="remove_choice_c_image">
              <label class="form-check-label" for="remove_choice_c_image">Remove image</label>
            </div>
          </div>
        {% endif %}
        <input type="file" name="choice_c_image" id="choice_c_image" accept="image/*" class="form-control">
        <div id="choice_c_image_preview_wrap" class="mt-2 d-none">
          <img id="choice_c_image_preview" class="img-thumbnail" style="max-height:140px" alt="New C image preview">
        </div>
      </div>

      <!-- Choice D -->
      <div class="col-md-6">
        <div class="mb-2">
          <label class="form-label">Choice D (text)</label>
          <input name="choice_d" class="form-control" value="{{ row.choice_d if row else '' }}">
          <div class="form-text">You may leave text empty if you upload an image.</div>
        </div>

        <label class="form-label">Choice D image</label>
        {% if row and row.choice_d_image_url %}
          <div class="d-flex align-items-start gap-3 mb-2">
            <img src="{{ row.choice_d_image_url }}" class="img-thumbnail" style="max-height:140px" alt="Current D image">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="remove_choice_d_image" id="remove_choice_d_image">
              <label class="form-check-label" for="remove_choice_d_image">Remove image</label>
            </div>
          </div>
        {% endif %}
        <input type="file" name="choice_d_image" id="choice_d_image" accept="image/*" class="form-control">
        <div id="choice_d_image_preview_wrap" class="mt-2 d-none">
          <img id="choice_d_image_preview" class="img-thumbnail" style="max-height:140px" alt="New D image preview">
        </div>
      </div>

      <!-- Correct + Category -->
      <div class="col-md-4">
        <label class="form-label">Correct answer</label>
        <select name="correct_answer" class="form-select">
          {% for L in ['A','B','C','D'] %}
            <option value="{{L}}" {% if row and row.correct_answer==L %}selected{% endif %}>{{L}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Category</label>
        <select name="category_id" class="form-select">
          <option value="">(none)</option>
          {% for c in categories %}
            <option value="{{c.id}}" {% if row and row.category_id==c.id %}selected{% endif %}>{{c.name}}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary">Save</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('admin_questions') }}">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Simple image preview helper
  function hookPreview(inputId, wrapId, imgId) {
    const input = document.getElementById(inputId);
    const wrap  = document.getElementById(wrapId);
    const img   = document.getElementById(imgId);
    if (!input || !wrap || !img) return;

    input.addEventListener('change', function () {
      const f = this.files && this.files[0];
      if (!f) { wrap.classList.add('d-none'); img.src = ''; return; }
      const url = URL.createObjectURL(f);
      img.src = url;
      wrap.classList.remove('d-none');
    });
  }

  hookPreview('question_image', 'question_image_preview_wrap', 'question_image_preview');
  hookPreview('choice_a_image', 'choice_a_image_preview_wrap', 'choice_a_image_preview');
  hookPreview('choice_b_image', 'choice_b_image_preview_wrap', 'choice_b_image_preview');
  hookPreview('choice_c_image', 'choice_c_image_preview_wrap', 'choice_c_image_preview');
  hookPreview('choice_d_image', 'choice_d_image_preview_wrap', 'choice_d_image_preview');
</script>
</body>
</html>
